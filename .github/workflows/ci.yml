name: CI

on:
  push:
    branches:
      - main

jobs:
    publish_helm:
        name: Publish Helm Chart
        runs-on: ubuntu-24.04
        permissions:
            attestations: write
            contents: read
            packages: write

        steps:
        - name: "Checkout repository"
          uses: actions/checkout@v4
        - name: "Cache Helm dependencies"
          uses: actions/cache@v3
          with:
            path: |
              ~/.cache/helm
              ./Chart.lock
              ./charts/**
            key: ${{ runner.os }}-helm-${{ hashFiles('**/Chart.lock') }}
            restore-keys: |
              ${{ runner.os }}-helm-
        - name: "Set up Helm"
          uses: azure/setup-helm@v4.2.0
        - name: "Login to Github OCI"
          uses: docker/login-action@v2
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}
        - name: "Package Helm Chart"
          run: |
            helm package .
        - name: "Publish Helm Chart"
          run: |
            helm push *.tgz oci://ghcr.io/${{ github.repository_owner }}/wordpress
